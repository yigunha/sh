<!DOCTYPE html>
<html>
<head>
    <style>
        /* 기존 스타일 유지 */
        .cell {
            position: absolute;
            width: 120px;
            height: 120px;
            background: white;
            border: 2px solid #333;
            border-radius: 5px;
            cursor: move;
            user-select: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 5px;
        }

        .cell input {
            width: 90%;
            border: none;
            text-align: center;
            outline: none;
        }

        .cell .image-container {
            width: 80px;
            height: 80px;
            border: 1px dashed #999;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 5px;
            position: relative;
        }

        .cell .image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            cursor: pointer;
        }

        .image-upload-button {
            position: absolute;
            top: 0;
            right: 0;
            background: #666;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 5px;
            cursor: pointer;
            font-size: 10px;
        }

        .connector {
            width: 10px;
            height: 10px;
            background: #666;
            border-radius: 50%;
            cursor: pointer;
        }

        #canvas {
            position: relative;
            width: 100%;
            height: 600px;
            background: #f0f0f0;
            overflow: hidden;
        }

        svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .hidden {
            display: none;
        }

        /* 전체화면 모달 스타일 추가 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }

        .close-button {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }

        /* 저장 버튼 스타일 */
        #saveBtn {
            margin: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="canvas">
        <svg id="connections"></svg>
    </div>

    <!-- 모달 추가 -->
    <div class="modal-overlay" id="imageModal">
        <div class="modal-content">
            <button class="close-button">&times;</button>
            <img id="modalImage" src="" alt="Fullscreen image">
        </div>
    </div>

    <!-- 저장 버튼 추가 -->
    <button id="saveBtn">Save</button>

    <script>
        let selectedConnector = null;
        let connections = [];
        let cellCount = 0;

        // 모달 관련 요소
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        const closeButton = document.querySelector('.close-button');

        // 모달 닫기 이벤트
        closeButton.onclick = function() {
            modal.style.display = 'none';
        }

        modal.onclick = function(e) {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        }

        document.getElementById('canvas').addEventListener('click', function(e) {
            if (e.target === this && e.ctrlKey) {
                createCell(e.offsetX, e.offsetY);
            }
        });

        function createCell(x, y) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.style.left = (x - 60) + 'px';
            cell.style.top = (y - 60) + 'px';
            
            const imageContainer = document.createElement('div');
            imageContainer.className = 'image-container';
            
            const img = document.createElement('img');
            img.src = '/api/placeholder/80/80';
            
            // 이미지 더블클릭 이벤트 추가
            img.addEventListener('dblclick', function(e) {
                e.stopPropagation();
                modalImg.src = this.src;
                modal.style.display = 'flex';
            });
            
            imageContainer.appendChild(img);
            
            const uploadButton = document.createElement('button');
            uploadButton.className = 'image-upload-button';
            uploadButton.textContent = '이미지';
            imageContainer.appendChild(uploadButton);
            
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.className = 'hidden';
            imageContainer.appendChild(fileInput);
            
            uploadButton.addEventListener('click', (e) => {
                e.stopPropagation();
                fileInput.click();
            });
            
            fileInput.addEventListener('change', function(e) {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            cell.appendChild(imageContainer);

            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Text';
            cell.appendChild(input);

            const connector = document.createElement('div');
            connector.className = 'connector';
            cell.appendChild(connector);

            document.getElementById('canvas').appendChild(cell);
            
            makeDraggable(cell);
            makeConnectable(connector);
            
            cellCount++;
            return cell;
        }

        // 드래그 가능 기능
        function makeDraggable(cell) {
            let isDragging = false;
            let currentX;
            let currentY;

            cell.addEventListener('mousedown', function(e) {
                if (e.target === cell) {
                    isDragging = true;
                    currentX = e.clientX - cell.offsetLeft;
                    currentY = e.clientY - cell.offsetTop;
                }
            });

            document.addEventListener('mousemove', function(e) {
                if (isDragging) {
                    cell.style.left = (e.clientX - currentX) + 'px';
                    cell.style.top = (e.clientY - currentY) + 'px';
                    updateConnections();
                }
            });

            document.addEventListener('mouseup', function() {
                isDragging = false;
            });
        }

        // 연결 가능 기능
        function makeConnectable(connector) {
            connector.addEventListener('mousedown', function(e) {
                e.stopPropagation();
                selectedConnector = connector;
            });

            connector.addEventListener('mouseup', function(e) {
                e.stopPropagation();
                if (selectedConnector && selectedConnector !== connector) {
                    if (!connections.some(conn => 
                        (conn.start === selectedConnector && conn.end === connector) ||
                        (conn.start === connector && conn.end === selectedConnector)
                    )) {
                        connections.push({
                            start: selectedConnector,
                            end: connector
                        });
                        updateConnections();
                    }
                }
                selectedConnector = null;
            });
        }

        function updateConnections() {
            const svg = document.getElementById('connections');
            svg.innerHTML = '';

            connections.forEach(connection => {
                const start = getConnectorCenter(connection.start);
                const end = getConnectorCenter(connection.end);

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', start.x);
                line.setAttribute('y1', start.y);
                line.setAttribute('x2', end.x);
                line.setAttribute('y2', end.y);
                line.setAttribute('stroke', '#666');
                line.setAttribute('stroke-width', '2');

                svg.appendChild(line);
            });
        }

        function getConnectorCenter(connector) {
            const rect = connector.getBoundingClientRect();
            const canvas = document.getElementById('canvas').getBoundingClientRect();
            return {
                x: rect.left + rect.width / 2 - canvas.left,
                y: rect.top + rect.height / 2 - canvas.top
            };
        }

        // 저장 버튼 클릭 시
        document.getElementById('saveBtn').addEventListener('click', saveToLocalStorage);

        // 로컬 스토리지에 저장
        function saveToLocalStorage() {
            const content = [];
            
            // 셀 내용과 이미지를 수집
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                const text = cell.querySelector('input').value;
                const image = cell.querySelector('.image-container img').src;
                content.push({ text, image });
            });

            // 로컬 스토리지에 저장
            localStorage.setItem('canvasData', JSON.stringify(content));
            alert('Content saved locally!');
        }

        // 페이지 로드 시 로컬 스토리지에서 불러오기
        window.onload = function() {
            const savedData = localStorage.getItem('canvasData');
            if (savedData) {
                const content = JSON.parse(savedData);
                content.forEach(item => {
                    const cell = createCell(100, 100); // 기본 위치
                    cell.querySelector('input').value = item.text;
                    cell.querySelector('.image-container img').src = item.image;
                });
            }
        };
    </script>
</body>
</html>
